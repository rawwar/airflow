{
  "type": "excalidraw",
  "version": 2,
  "source": "https://excalidraw.com",
  "elements": [
    {
      "type": "text",
      "id": "title",
      "x": 300,
      "y": 50,
      "width": 800,
      "height": 45,
      "strokeColor": "#1e1e1e",
      "backgroundColor": "transparent",
      "text": "The Critical Decision Point",
      "fontSize": 36,
      "fontFamily": 1,
      "textAlign": "center"
    },
    {
      "type": "text",
      "id": "subtitle",
      "x": 400,
      "y": 110,
      "width": 600,
      "height": 35,
      "strokeColor": "#868e96",
      "backgroundColor": "transparent",
      "text": "How next_dagrun_create_after determines scheduling",
      "fontSize": 20,
      "fontFamily": 1,
      "textAlign": "center"
    },
    {
      "type": "rectangle",
      "id": "phase1_box",
      "x": 100,
      "y": 200,
      "width": 1200,
      "height": 350,
      "strokeColor": "#1098ad",
      "backgroundColor": "#e7f5ff",
      "fillStyle": "solid",
      "strokeWidth": 3,
      "roughness": 0,
      "opacity": 50,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "phase1_title",
      "x": 120,
      "y": 215,
      "width": 400,
      "height": 35,
      "strokeColor": "#1098ad",
      "backgroundColor": "transparent",
      "text": "Phase 1: Calculation (Dag Processor)",
      "fontSize": 24,
      "fontFamily": 1,
      "textAlign": "left",
      "fontWeight": "bold"
    },
    {
      "type": "rectangle",
      "id": "parse_dag",
      "x": 150,
      "y": 280,
      "width": 200,
      "height": 80,
      "strokeColor": "#1e1e1e",
      "backgroundColor": "#4ecdc4",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roughness": 1,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "text_parse",
      "x": 170,
      "y": 305,
      "width": 160,
      "height": 30,
      "text": "Parse DAG",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "center",
      "containerId": "parse_dag"
    },
    {
      "type": "rectangle",
      "id": "query_last",
      "x": 400,
      "y": 280,
      "width": 200,
      "height": 80,
      "strokeColor": "#1e1e1e",
      "backgroundColor": "#4ecdc4",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roughness": 1,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "text_query_last",
      "x": 420,
      "y": 295,
      "width": 160,
      "height": 50,
      "text": "Query Last\nAutomated Run",
      "fontSize": 16,
      "fontFamily": 1,
      "textAlign": "center",
      "containerId": "query_last"
    },
    {
      "type": "rectangle",
      "id": "timetable",
      "x": 650,
      "y": 280,
      "width": 200,
      "height": 80,
      "strokeColor": "#1e1e1e",
      "backgroundColor": "#4ecdc4",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roughness": 1,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "text_timetable",
      "x": 670,
      "y": 305,
      "width": 160,
      "height": 30,
      "text": "Timetable Logic",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "center",
      "containerId": "timetable"
    },
    {
      "type": "rectangle",
      "id": "store_db",
      "x": 900,
      "y": 280,
      "width": 350,
      "height": 80,
      "strokeColor": "#1e1e1e",
      "backgroundColor": "#4ecdc4",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roughness": 1,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "text_store",
      "x": 920,
      "y": 295,
      "width": 310,
      "height": 50,
      "text": "Store in DagModel Table",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "center",
      "containerId": "store_db"
    },
    {
      "type": "arrow",
      "id": "arrow_p1_1",
      "x": 350,
      "y": 320,
      "width": 50,
      "height": 0,
      "strokeColor": "#1e1e1e",
      "strokeWidth": 3,
      "startArrowhead": null,
      "endArrowhead": "arrow",
      "points": [[0, 0], [50, 0]]
    },
    {
      "type": "arrow",
      "id": "arrow_p1_2",
      "x": 600,
      "y": 320,
      "width": 50,
      "height": 0,
      "strokeColor": "#1e1e1e",
      "strokeWidth": 3,
      "startArrowhead": null,
      "endArrowhead": "arrow",
      "points": [[0, 0], [50, 0]]
    },
    {
      "type": "arrow",
      "id": "arrow_p1_3",
      "x": 850,
      "y": 320,
      "width": 50,
      "height": 0,
      "strokeColor": "#1e1e1e",
      "strokeWidth": 3,
      "startArrowhead": null,
      "endArrowhead": "arrow",
      "points": [[0, 0], [50, 0]]
    },
    {
      "type": "rectangle",
      "id": "key_field",
      "x": 300,
      "y": 420,
      "width": 800,
      "height": 100,
      "strokeColor": "#f08c00",
      "backgroundColor": "#ffd93d",
      "fillStyle": "solid",
      "strokeWidth": 4,
      "roughness": 1,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "text_key_field",
      "x": 320,
      "y": 430,
      "width": 760,
      "height": 80,
      "strokeColor": "#1e1e1e",
      "text": "next_dagrun_create_after = 2024-01-02 00:00:00\n\nThe timestamp when the scheduler should create this DAG run",
      "fontSize": 20,
      "fontFamily": 3,
      "textAlign": "center",
      "verticalAlign": "middle",
      "containerId": "key_field"
    },
    {
      "type": "rectangle",
      "id": "decision_box",
      "x": 100,
      "y": 620,
      "width": 1200,
      "height": 250,
      "strokeColor": "#e03131",
      "backgroundColor": "#ffe3e3",
      "fillStyle": "solid",
      "strokeWidth": 5,
      "roughness": 0,
      "opacity": 50,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "decision_title",
      "x": 120,
      "y": 635,
      "width": 600,
      "height": 45,
      "strokeColor": "#e03131",
      "backgroundColor": "transparent",
      "text": "THE CRITICAL DECISION",
      "fontSize": 32,
      "fontFamily": 1,
      "textAlign": "left",
      "fontWeight": "bold"
    },
    {
      "type": "rectangle",
      "id": "sql_query",
      "x": 200,
      "y": 710,
      "width": 1000,
      "height": 130,
      "strokeColor": "#c92a2a",
      "backgroundColor": "#fff5f5",
      "fillStyle": "solid",
      "strokeWidth": 3,
      "roughness": 1,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "text_sql",
      "x": 220,
      "y": 720,
      "width": 960,
      "height": 110,
      "strokeColor": "#1e1e1e",
      "text": "SELECT * FROM dag_model\nWHERE is_paused = FALSE\n  AND is_stale = FALSE\n  AND has_import_errors = FALSE\n  AND next_dagrun_create_after <= NOW()    â† THE CHECK",
      "fontSize": 18,
      "fontFamily": 3,
      "textAlign": "left",
      "containerId": "sql_query"
    },
    {
      "type": "rectangle",
      "id": "phase2_box",
      "x": 100,
      "y": 940,
      "width": 1200,
      "height": 350,
      "strokeColor": "#2f9e44",
      "backgroundColor": "#d3f9d8",
      "fillStyle": "solid",
      "strokeWidth": 3,
      "roughness": 0,
      "opacity": 50,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "phase2_title",
      "x": 120,
      "y": 955,
      "width": 400,
      "height": 35,
      "strokeColor": "#2f9e44",
      "backgroundColor": "transparent",
      "text": "Phase 2: Execution (Scheduler)",
      "fontSize": 24,
      "fontFamily": 1,
      "textAlign": "left",
      "fontWeight": "bold"
    },
    {
      "type": "rectangle",
      "id": "query_where",
      "x": 150,
      "y": 1020,
      "width": 250,
      "height": 80,
      "strokeColor": "#1e1e1e",
      "backgroundColor": "#95e1d3",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roughness": 1,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "text_query_where",
      "x": 170,
      "y": 1035,
      "width": 210,
      "height": 50,
      "text": "Query WHERE\ncondition",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "center",
      "containerId": "query_where"
    },
    {
      "type": "rectangle",
      "id": "create_dagrun",
      "x": 450,
      "y": 1020,
      "width": 250,
      "height": 80,
      "strokeColor": "#2f9e44",
      "backgroundColor": "#b2f2bb",
      "fillStyle": "solid",
      "strokeWidth": 3,
      "roughness": 1,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "text_create_dagrun",
      "x": 470,
      "y": 1045,
      "width": 210,
      "height": 30,
      "text": "Create DagRun",
      "fontSize": 20,
      "fontFamily": 1,
      "textAlign": "center",
      "fontWeight": "bold",
      "containerId": "create_dagrun"
    },
    {
      "type": "rectangle",
      "id": "update_next",
      "x": 750,
      "y": 1020,
      "width": 250,
      "height": 80,
      "strokeColor": "#1e1e1e",
      "backgroundColor": "#95e1d3",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roughness": 1,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "text_update",
      "x": 770,
      "y": 1035,
      "width": 210,
      "height": 50,
      "text": "Update for\nNext Run",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "center",
      "containerId": "update_next"
    },
    {
      "type": "arrow",
      "id": "arrow_p2_1",
      "x": 400,
      "y": 1060,
      "width": 50,
      "height": 0,
      "strokeColor": "#1e1e1e",
      "strokeWidth": 3,
      "startArrowhead": null,
      "endArrowhead": "arrow",
      "points": [[0, 0], [50, 0]]
    },
    {
      "type": "arrow",
      "id": "arrow_p2_2",
      "x": 700,
      "y": 1060,
      "width": 50,
      "height": 0,
      "strokeColor": "#1e1e1e",
      "strokeWidth": 3,
      "startArrowhead": null,
      "endArrowhead": "arrow",
      "points": [[0, 0], [50, 0]]
    },
    {
      "type": "rectangle",
      "id": "loop_text",
      "x": 350,
      "y": 1170,
      "width": 700,
      "height": 80,
      "strokeColor": "#1971c2",
      "backgroundColor": "#e7f5ff",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roughness": 1,
      "roundness": { "type": 3 }
    },
    {
      "type": "text",
      "id": "text_loop",
      "x": 370,
      "y": 1195,
      "width": 660,
      "height": 30,
      "text": "Loop continues every ~1 second",
      "fontSize": 20,
      "fontFamily": 1,
      "textAlign": "center",
      "containerId": "loop_text"
    },
    {
      "type": "arrow",
      "id": "arrow_connect1",
      "x": 700,
      "y": 360,
      "width": 0,
      "height": 60,
      "strokeColor": "#f08c00",
      "strokeWidth": 4,
      "strokeStyle": "dashed",
      "startArrowhead": null,
      "endArrowhead": "arrow",
      "points": [[0, 0], [0, 60]]
    },
    {
      "type": "arrow",
      "id": "arrow_connect2",
      "x": 700,
      "y": 520,
      "width": 0,
      "height": 100,
      "strokeColor": "#e03131",
      "strokeWidth": 5,
      "startArrowhead": null,
      "endArrowhead": "arrow",
      "points": [[0, 0], [0, 100]]
    },
    {
      "type": "text",
      "id": "text_arrow2",
      "x": 720,
      "y": 550,
      "width": 300,
      "height": 40,
      "strokeColor": "#e03131",
      "text": "Database query uses this\nfield to make decision",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left"
    },
    {
      "type": "arrow",
      "id": "arrow_connect3",
      "x": 700,
      "y": 870,
      "width": 0,
      "height": 70,
      "strokeColor": "#2f9e44",
      "strokeWidth": 3,
      "startArrowhead": null,
      "endArrowhead": "arrow",
      "points": [[0, 0], [0, 70]]
    },
    {
      "type": "arrow",
      "id": "arrow_loop",
      "x": 1000,
      "y": 1060,
      "width": 350,
      "height": 840,
      "strokeColor": "#f08c00",
      "strokeWidth": 3,
      "strokeStyle": "dashed",
      "startArrowhead": null,
      "endArrowhead": "arrow",
      "points": [[0, 0], [150, 0], [150, -840], [-850, -840]]
    },
    {
      "type": "text",
      "id": "text_arrow_loop",
      "x": 1050,
      "y": 600,
      "width": 200,
      "height": 50,
      "strokeColor": "#f08c00",
      "text": "Updates this field\nfor next iteration",
      "fontSize": 16,
      "fontFamily": 1,
      "textAlign": "center"
    },
    {
      "type": "text",
      "id": "summary",
      "x": 200,
      "y": 1350,
      "width": 1000,
      "height": 120,
      "strokeColor": "#495057",
      "backgroundColor": "transparent",
      "text": "Summary:\n1. Dag Processor CALCULATES when the run should be created\n2. Stores the timestamp in next_dagrun_create_after\n3. Scheduler QUERIES and compares with NOW()\n4. When condition is true, scheduler CREATES the run\n5. Immediately updates next_dagrun_create_after for the next run",
      "fontSize": 16,
      "fontFamily": 1,
      "textAlign": "left",
      "lineHeight": 1.4
    }
  ],
  "appState": {
    "gridSize": 10,
    "viewBackgroundColor": "#ffffff"
  },
  "files": {}
}
